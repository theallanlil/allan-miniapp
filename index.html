<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hello, Warpcast! + Auth</title>

  <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —à–µ—Ä–∏–Ω–≥–∞ –≤ Farcaster -->
  <meta name="fc:miniapp" content='{
    "version":"1",
    "imageUrl":"https://allan-miniapp.vercel.app/og.png",
    "button":{
      "title":"Open",
      "action":{"type":"launch_miniapp","url":"https://allan-miniapp.vercel.app/"}
    }
  }' />

  <style>
    :root { --bg:#0e0f13; --panel:#14161c; --muted:#9aa3b2; --border:#2b2f3a; --fg:#e6e6e6; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--fg); display: grid; place-items: center; min-height: 100dvh; }
    .card { width: min(640px, 94vw); border: 1px solid var(--border); border-radius: 16px; padding: 22px; background: var(--panel); box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin: 0 0 12px; font-size: 28px; }
    p { margin: 8px 0; color: var(--muted); }
    .row { display: flex; gap: 16px; align-items: center; }
    .pfp { width: 72px; height: 72px; border-radius: 50%; overflow: hidden; background: #222; flex: 0 0 auto; }
    .pfp img { width: 100%; height: 100%; object-fit: cover; }
    .actions { display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap; }
    button, a.btn { padding: 12px 16px; border-radius: 10px; border: 1px solid var(--border); background: transparent; color: var(--fg); cursor: pointer; text-decoration: none; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .small { font-size: 13px; }
    .ok { color: #6de38f; }
    .err { color: #f66; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; word-break: break-word; }
    .hide { display: none; }
  </style>
</head>
<body>
  <div class="card">
    <div class="row">
      <div class="pfp" id="pfp"></div>
      <div>
        <h1 id="hello">Loading‚Ä¶</h1>
        <p>Welcome to your first Farcaster Mini App with Quick Auth üéâ</p>
      </div>
    </div>

    <div class="actions">
      <button id="btnAuth">üîê Sign in (get JWT)</button>
      <a class="btn" id="openLink" href="#">Open in Warpcast</a>
    </div>

    <p class="small">Tip: if you see ‚ÄúLoading‚Ä¶‚Äù forever, ensure <code>sdk.actions.ready()</code> resolves and the app is served over HTTPS.</p>

    <div id="status" class="small mono"></div>
    <div id="fallback" class="small err hide">Looks like we are outside a Farcaster client. You can still deploy and test via the Mini App Debug Tool.</div>
  </div>

  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk'

    const hello = document.getElementById('hello')
    const pfp = document.getElementById('pfp')
    const fallback = document.getElementById('fallback')
    const statusEl = document.getElementById('status')
    const btnAuth = document.getElementById('btnAuth')
    const openLink = document.getElementById('openLink')

    const DOMAIN = "allan-miniapp.vercel.app"
    openLink.href = `https://farcaster.xyz/miniapps/launch?url=${encodeURIComponent('https://' + DOMAIN + '/')}`

    function log(msg, cls) {
      const line = document.createElement('div')
      if (cls) line.classList.add(cls)
      line.textContent = msg
      statusEl.appendChild(line)
    }

    try {
      await sdk.actions.ready()

      const supportsUser = !!sdk.user?.getInfo
      const supportsAuth =
        !!sdk.auth?.quickAuth || !!sdk.auth?.signIn || !!sdk.actions?.signIn

      if (!supportsAuth) {
        btnAuth.disabled = true
        btnAuth.textContent = 'Open in Warpcast to Sign in'
      }

      if (supportsUser) {
        const info = await sdk.user.getInfo().catch(() => null)
        const name = info?.username || 'friend'
        hello.textContent = `üëã Hello, ${name}!`
        if (info?.pfpUrl) {
          const img = new Image()
          img.src = info.pfpUrl
          img.alt = 'pfp'
          img.referrerPolicy = 'no-referrer'
          pfp.appendChild(img)
        }
      } else {
        hello.textContent = 'Hello!'
      }

      log('SDK ready ‚úì', 'ok')

      btnAuth.addEventListener('click', async () => {
        if (btnAuth.disabled) return
        statusEl.innerHTML = ''
        log('Starting Quick Auth‚Ä¶')
        try {
          let jwt = null
          if (sdk.auth?.quickAuth) {
            jwt = await sdk.auth.quickAuth()
          } else if (sdk.auth?.signIn) {
            const r = await sdk.auth.signIn(); jwt = r?.token || r?.jwt || null
          } else if (sdk.actions?.signIn) {
            const r = await sdk.actions.signIn(); jwt = r?.token || r?.jwt || null
          }
          if (!jwt) throw new Error('Auth not available in this client')

          const short = String(jwt).slice(0, 48) + '‚Ä¶'
          log('JWT received: ' + short, 'ok')

          const resp = await fetch('/api/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: jwt })
          })
          const data = await resp.json().catch(() => ({}))
          log('Backend reply:\n' + JSON.stringify(data, null, 2), resp.ok ? 'ok' : 'err')
        } catch (e) {
          log('Auth error: ' + (e?.message || e), 'err')
        }
      })

    } catch (e) {
      fallback.classList.remove('hide')
      log('MiniApp init error: ' + (e?.message || e), 'err')
    }
  </script>
</body>
</html>
